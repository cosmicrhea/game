import Foundation
import PackagePlugin

@main
struct BuildToolPlugin: PackagePlugin.BuildToolPlugin {
  func createBuildCommands(context: PluginContext, target: Target) async throws -> [Command] {
    let versionOutputFile = context.pluginWorkDirectoryURL.appendingPathComponent("Version.swift")
    let versionScriptFile = context.pluginWorkDirectoryURL.appendingPathComponent("generate_version.sh")

    let registrationOutputFile = context.pluginWorkDirectoryURL.appendingPathComponent("SceneScriptRegistration.swift")
    let registrationScriptFile = context.pluginWorkDirectoryURL.appendingPathComponent("generate_registration.sh")

    // Create a shell script that will work better with Xcode
    let versionScriptContent = """
      #!/bin/sh
      set -e

      # Get git commit count
      COMMIT_COUNT=$(git rev-list --count HEAD 2>/dev/null || echo "0")

      # Generate version information
      MAJOR_VERSION=0
      MINOR_VERSION=$COMMIT_COUNT
      VERSION_STRING="$MAJOR_VERSION.$MINOR_VERSION"

      # Generate the Swift file
      cat > "\(versionOutputFile.path)" << EOF
      // Auto-generated version information
      // Generated on: $(date)
      // Commit count: $COMMIT_COUNT

      extension Engine {
          public static let versionMajor = $MAJOR_VERSION
          public static let versionMinor = $MINOR_VERSION
          public static let versionPatch = 0
          
          public static let versionString = "$VERSION_STRING"
          public static let versionFullString = "$VERSION_STRING.0"
          
          public static let commitCount = $COMMIT_COUNT
      }
      EOF

      echo "Generated version: $VERSION_STRING (commit count: $COMMIT_COUNT)"
      """

    // Create script to scan for @SceneScript classes and generate registration
    let registrationScriptContent = """
      #!/bin/sh
      set -e

      PACKAGE_DIR="\(context.package.directoryURL.path)"
      SCENES_DIR="$PACKAGE_DIR/Sources/Scenes"

      # Find all Swift files in Sources/Scenes that contain @SceneScript
      SCENE_SCRIPTS=""
      if [ -d "$SCENES_DIR" ]; then
        SCENE_SCRIPTS=$(find "$SCENES_DIR" -name "*.swift" -type f 2>/dev/null | xargs grep -l "@SceneScript" 2>/dev/null || true)
      fi

      # Extract class names from files with @SceneScript
      CLASSES=""
      if [ -n "$SCENE_SCRIPTS" ]; then
        for file in $SCENE_SCRIPTS; do
          # Extract class name after @SceneScript (look for "class ClassName:")
          CLASS_NAME=$(grep -A 1 "@SceneScript" "$file" 2>/dev/null | grep -E "^class [A-Za-z][A-Za-z0-9_]*" | sed 's/^class \\([A-Za-z][A-Za-z0-9_]*\\).*/\\1/' || true)
          if [ -n "$CLASS_NAME" ]; then
            CLASSES="$CLASSES $CLASS_NAME"
          fi
        done
      fi

      # Generate registration code that will be embedded in ScriptHotReload.swift
      # We'll generate a function that calls _register() on each script class
      cat > "\(registrationOutputFile.path)" << 'REGEOF'
      // Auto-generated scene script registration
      // Generated on: $(date)
      // This file is automatically generated - do not edit manually

      import Foundation

      @MainActor
      func registerAllSceneScripts() {
        // Register all @SceneScript classes
        logger.trace("ðŸ”„ registerAllSceneScripts() called")
      REGEOF

      if [ -n "$CLASSES" ]; then
        for class_name in $CLASSES; do
          echo "  $class_name._register()" >> "\(registrationOutputFile.path)"
        done
      fi

      cat >> "\(registrationOutputFile.path)" << 'REGEOF'
      }
      REGEOF

      # Also generate a simple list of class names for direct registration
      cat > "\(registrationOutputFile.path).classes" << 'CLASSEOF'
      // Auto-generated list of scene script class names
      // Generated on: $(date)
      // This file is automatically generated - do not edit manually
      CLASSEOF

      if [ -n "$CLASSES" ]; then
        for class_name in $CLASSES; do
          echo "$class_name" >> "\(registrationOutputFile.path).classes"
        done
      fi

      if [ -n "$CLASSES" ]; then
        echo "Generated scene script registration with classes: $CLASSES"
      else
        echo "No @SceneScript classes found - generated empty registration"
      fi
      """

    // Write the scripts to temporary files
    try versionScriptContent.write(to: versionScriptFile, atomically: true, encoding: String.Encoding.utf8)
    try registrationScriptContent.write(to: registrationScriptFile, atomically: true, encoding: String.Encoding.utf8)

    return [
      .buildCommand(
        displayName: "Generate Version Information",
        executable: URL(fileURLWithPath: "/bin/sh"),
        arguments: [versionScriptFile.path],
        outputFiles: [versionOutputFile]
      ),
      .buildCommand(
        displayName: "Generate Scene Script Registration",
        executable: URL(fileURLWithPath: "/bin/sh"),
        arguments: [registrationScriptFile.path],
        outputFiles: [registrationOutputFile]
      ),
    ]
  }
}
