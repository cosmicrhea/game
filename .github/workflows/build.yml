name: build

on:
  push:
    branches: [main]
  pull_request:

permissions:
  contents: read

jobs:
  build:
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: macOS
            runner: macos-15
          - os: Linux
            runner: ubuntu-22.04
          - os: Windows
            runner: windows-2022
    runs-on: ${{ matrix.runner }}
    name: ${{ matrix.os }}
    env:
      GAME_LOCAL_DEPS: "0"
      DEVELOPER_DIR: /Applications/Xcode_26.0.1.app/Contents/Developer
    steps:
      - name: Checkout glass
        uses: actions/checkout@v4
        with:
          path: glass
          lfs: true

      - name: Set up Swift 6.2 (Linux)
        if: runner.os == 'Linux'
        uses: mman/setup-swift@main
        with:
          swift-version: "6.2"

      - name: Set up Swift 6.2 (Windows)
        if: runner.os == 'Windows'
        run: |
          # Install winget if not available
          Write-Host "Checking for winget..."
          try {
            $wingetVersion = winget --version
            Write-Host "winget found: $wingetVersion"
          } catch {
            Write-Host "winget not found, installing it..."
            # Use the winget-install script
            Invoke-Expression "& { $(Invoke-RestMethod 'https://raw.githubusercontent.com/asheroto/winget-install/master/winget-install.ps1') }"
            Write-Host "winget installed, checking version..."
            $wingetVersion = winget --version
            Write-Host "winget version after install: $wingetVersion"
          }

          # Try to install Swift via winget first
          Write-Host "Attempting to install Swift via winget..."
          Write-Host "Running: winget install --id Swift.Toolchain -e --accept-package-agreements --accept-source-agreements"
          $wingetResult = winget install --id Swift.Toolchain -e --accept-package-agreements --accept-source-agreements 2>&1
          Write-Host "Winget install result: $wingetResult"
          Write-Host "Winget install exit code: $LASTEXITCODE"

          # Check both possible installation paths
          $swiftPaths = @(
            "$env:LOCALAPPDATA\Programs\Swift\bin",
            "C:\Program Files\Swift\bin"
          )

          $swiftFound = $false
          foreach ($swiftPath in $swiftPaths) {
            if (Test-Path $swiftPath) {
              $env:PATH = "$swiftPath;$env:PATH"
              echo "$swiftPath" >> $env:GITHUB_PATH
              Write-Host "Swift installed via winget successfully at: $swiftPath"
              $swiftFound = $true
              break
            }
          }

          if ($swiftFound) {
            Write-Host "Swift found via winget, skipping manual installation"
          } else {
            Write-Host "Swift not found in expected paths after winget installation"
            
            # Debug: Check what winget packages are installed
            Write-Host "Checking installed winget packages..."
            winget list | Select-String -Pattern "swift" -CaseSensitive:$false

            # Debug: Search for Swift packages
            Write-Host "Searching for Swift packages in winget..."
            winget search swift

            Write-Host "Trying manual installation..."
          }

          # Fallback: Download and install Swift 6.2 for Windows manually
          $swiftUrl = "https://download.swift.org/swift-6.2-release/windows10/swift-6.2-RELEASE/swift-6.2-RELEASE-windows10.exe"
          $swiftInstaller = "$env:TEMP\swift-installer.exe"
          Write-Host "Downloading Swift from $swiftUrl"
          Invoke-WebRequest -Uri $swiftUrl -OutFile $swiftInstaller

          # Install Swift silently
          Write-Host "Installing Swift..."
          $installProcess = Start-Process -FilePath $swiftInstaller -ArgumentList "/S" -Wait -PassThru
          Write-Host "Swift installer exit code: $($installProcess.ExitCode)"

          # Wait a moment for installation to complete
          Start-Sleep -Seconds 5

          # Check both possible installation paths after manual installation
          $swiftPaths = @(
            "$env:LOCALAPPDATA\Programs\Swift\bin",
            "C:\Program Files\Swift\bin"
          )

          $swiftFound = $false
          foreach ($swiftPath in $swiftPaths) {
            if (Test-Path $swiftPath) {
              $env:PATH = "$swiftPath;$env:PATH"
              echo "$swiftPath" >> $env:GITHUB_PATH
              Write-Host "Added Swift to PATH: $swiftPath"
              $swiftFound = $true
              break
            }
          }

          if (-not $swiftFound) {
            Write-Host "Swift installation path not found in any expected location"
            Write-Host "Checked paths: $($swiftPaths -join ', ')"
            # List all Swift-related directories for debugging
            Write-Host "Searching for Swift installations..."
            Get-ChildItem -Path "$env:LOCALAPPDATA\Programs" -Name "*swift*" -ErrorAction SilentlyContinue | ForEach-Object { Write-Host "Found in LocalAppData: $_" }
            Get-ChildItem -Path "C:\Program Files" -Name "*swift*" -ErrorAction SilentlyContinue | ForEach-Object { Write-Host "Found in Program Files: $_" }
            Get-ChildItem -Path "C:\Program Files (x86)" -Name "*swift*" -ErrorAction SilentlyContinue | ForEach-Object { Write-Host "Found in Program Files (x86): $_" }
            
            # Check if winget actually installed anything
            Write-Host "Checking winget installed packages..."
            winget list --name "Swift" 2>$null | ForEach-Object { Write-Host "Winget Swift packages: $_" }
            
            # Try to find Swift anywhere on the system
            Write-Host "Searching entire C: drive for swift.exe..."
            $swiftExe = Get-ChildItem -Path "C:\" -Name "swift.exe" -Recurse -ErrorAction SilentlyContinue | Select-Object -First 5
            if ($swiftExe) {
              Write-Host "Found swift.exe at: $($swiftExe -join ', ')"
            } else {
              Write-Host "No swift.exe found anywhere on C: drive"
            }
          }

      - name: Install macOS dependencies
        if: runner.os == 'macOS'
        run: |
          brew install assimp

      - name: Install Linux dependencies
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            cmake \
            ninja-build \
            pkg-config \
            xorg-dev \
            libwayland-dev \
            libxrandr-dev \
            libxi-dev \
            libxcursor-dev \
            libxinerama-dev \
            libxkbcommon-dev \
            mesa-common-dev \
            libgl1-mesa-dev \
            libglu1-mesa-dev \
            libasound2-dev \
            libpulse-dev \
            libudev-dev \
            zlib1g-dev \
            libassimp-dev

      - name: Clear SwiftPM cache (macOS & Linux)
        if: runner.os != 'Windows'
        run: |
          rm -rf ~/.swiftpm
          rm -rf glass/.build
          rm -rf glass/.swiftpm
          rm -f glass/Package.resolved
          cd glass && swift package clean

      - name: Clear SwiftPM cache (Windows)
        if: runner.os == 'Windows'
        run: |
          Remove-Item -Recurse -Force "$env:USERPROFILE\.swiftpm" -ErrorAction SilentlyContinue
          Remove-Item -Recurse -Force "glass\.build" -ErrorAction SilentlyContinue
          Remove-Item -Recurse -Force "glass\.swiftpm" -ErrorAction SilentlyContinue
          Remove-Item -Force "glass\Package.resolved" -ErrorAction SilentlyContinue

      # - name: Cache SwiftPM
      #   uses: actions/cache@v4
      #   with:
      #     path: |
      #       ~/.swiftpm
      #       glass/.build
      #     key: ${{ runner.os }}-spm-${{ hashFiles('glass/Package.resolved') }}
      #     restore-keys: |
      #       ${{ runner.os }}-spm-

      - name: Show Swift version (macOS & Linux)
        if: runner.os != 'Windows'
        run: swift --version

      - name: Show Swift version (Windows)
        if: runner.os == 'Windows'
        run: |
          Write-Host "Checking Swift installation on Windows..."
          $swiftPaths = @(
            "$env:LOCALAPPDATA\Programs\Swift\bin",
            "C:\Program Files\Swift\bin"
          )
          foreach ($swiftPath in $swiftPaths) {
            if (Test-Path $swiftPath) {
              Write-Host "Found Swift at: $swiftPath"
              $env:PATH = "$swiftPath;$env:PATH"
              break
            }
          }
          Write-Host "Current PATH: $env:PATH"
          swift --version

      - name: Build (debug) - macOS & Linux
        if: runner.os != 'Windows'
        working-directory: glass
        run: swift build --quiet --enable-experimental-prebuilts

      - name: Build (debug) - Windows
        if: runner.os == 'Windows'
        working-directory: glass
        run: |
          # Ensure Swift is in PATH for Windows
          $swiftPaths = @(
            "$env:LOCALAPPDATA\Programs\Swift\bin",
            "C:\Program Files\Swift\bin"
          )
          foreach ($swiftPath in $swiftPaths) {
            if (Test-Path $swiftPath) {
              $env:PATH = "$swiftPath;$env:PATH"
              break
            }
          }
          swift build --quiet --enable-experimental-prebuilts

      - name: Build (release) - macOS & Linux
        if: runner.os != 'Windows'
        working-directory: glass
        run: swift build -c release --quiet --enable-experimental-prebuilts

      - name: Create macOS App Bundle
        if: runner.os == 'macOS'
        working-directory: glass
        run: |
          swift .scripts/make-app-bundle.swift
          ls -la *.app

      - name: Upload macOS App Bundle
        if: runner.os == 'macOS'
        uses: actions/upload-artifact@v4
        with:
          name: glass-app-macos
          path: glass/*.app
          retention-days: 30

      - name: Build (release) - Windows
        if: runner.os == 'Windows'
        working-directory: glass
        run: |
          # Ensure Swift is in PATH for Windows
          $swiftPaths = @(
            "$env:LOCALAPPDATA\Programs\Swift\bin",
            "C:\Program Files\Swift\bin"
          )
          foreach ($swiftPath in $swiftPaths) {
            if (Test-Path $swiftPath) {
              $env:PATH = "$swiftPath;$env:PATH"
              break
            }
          }
          swift build -c release --quiet --enable-experimental-prebuilts
