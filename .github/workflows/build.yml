name: build

on:
  push:
    branches: [main]
  pull_request:

permissions:
  contents: read

jobs:
  build:
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: macOS
            runner: macos-15
          - os: Linux
            runner: ubuntu-22.04
          - os: Windows
            runner: windows-2022
    runs-on: ${{ matrix.runner }}
    name: ${{ matrix.os }}
    env:
      GAME_LOCAL_DEPS: "0"
    steps:
      - name: Checkout glass
        uses: actions/checkout@v4
        with:
          path: glass

      # Dependencies will be downloaded through Package.swift
      # - name: Checkout assimp
      #   uses: actions/checkout@v4
      #   with:
      #     repository: cosmicrhea-game/assimp
      #     path: glass-deps/assimp
      #     persist-credentials: false

      # - name: Checkout gl
      #   uses: actions/checkout@v4
      #   with:
      #     repository: cosmicrhea-game/gl
      #     path: glass-deps/gl
      #     persist-credentials: false

      # - name: Checkout gl-math
      #   uses: actions/checkout@v4
      #   with:
      #     repository: cosmicrhea-game/gl-math
      #     path: glass-deps/gl-math
      #     persist-credentials: false

      # - name: Checkout glfw-swift
      #   uses: actions/checkout@v4
      #   with:
      #     repository: cosmicrhea-game/glfw-swift
      #     path: glass-deps/glfw-swift
      #     persist-credentials: false

      # - name: Checkout jolt
      #   uses: actions/checkout@v4
      #   with:
      #     repository: cosmicrhea-game/jolt
      #     path: glass-deps/jolt
      #     persist-credentials: false

      # - name: Checkout miniaudio
      #   uses: actions/checkout@v4
      #   with:
      #     repository: cosmicrhea-game/miniaudio
      #     path: glass-deps/miniaudio
      #     persist-credentials: false

      # - name: Checkout nanosvg
      #   uses: actions/checkout@v4
      #   with:
      #     repository: cosmicrhea-game/nanosvg
      #     path: glass-deps/nanosvg
      #     persist-credentials: false

      # - name: Checkout stb-perlin
      #   uses: actions/checkout@v4
      #   with:
      #     repository: cosmicrhea-game/stb-perlin
      #     path: glass-deps/stb-perlin
      #     persist-credentials: false

      # - name: Checkout stb-rect-pack
      #   uses: actions/checkout@v4
      #   with:
      #     repository: cosmicrhea-game/stb-rect-pack
      #     path: glass-deps/stb-rect-pack
      #     persist-credentials: false

      # - name: Checkout stb-text-edit
      #   uses: actions/checkout@v4
      #   with:
      #     repository: cosmicrhea-game/stb-text-edit
      #     path: glass-deps/stb-text-edit
      #     persist-credentials: false

      # - name: Checkout stb-truetype
      #   uses: actions/checkout@v4
      #   with:
      #     repository: cosmicrhea-game/stb-truetype
      #     path: glass-deps/stb-truetype
      #     persist-credentials: false

      # - name: Checkout swift-image-formats
      #   uses: actions/checkout@v4
      #   with:
      #     repository: cosmicrhea-game/swift-image-formats
      #     path: glass-deps/swift-image-formats
      #     persist-credentials: false

      # - name: Checkout tinyexr
      #   uses: actions/checkout@v4
      #   with:
      #     repository: cosmicrhea-game/tinyexr
      #     path: glass-deps/tinyexr
      #     persist-credentials: false

      - name: Set up Swift 6.2 (macOS & Linux)
        if: runner.os != 'Windows'
        uses: mman/setup-swift@main
        with:
          swift-version: "6.2"

      - name: Set up Swift 6.2 (Windows)
        if: runner.os == 'Windows'
        run: |
          # Check if winget is available
          Write-Host "Checking for winget..."
          try {
            $wingetVersion = winget --version
            Write-Host "winget found: $wingetVersion"
            
            # Try to install Swift via winget first
            Write-Host "Attempting to install Swift via winget..."
            winget install --id Swift.Toolchain -e --accept-package-agreements --accept-source-agreements
            
            # Check both possible installation paths
            $swiftPaths = @(
              "$env:LOCALAPPDATA\Programs\Swift\bin",
              "C:\Program Files\Swift\bin"
            )
            
            foreach ($swiftPath in $swiftPaths) {
              if (Test-Path $swiftPath) {
                $env:PATH = "$swiftPath;$env:PATH"
                echo "$swiftPath" >> $env:GITHUB_PATH
                Write-Host "Swift installed via winget successfully at: $swiftPath"
                exit 0
              }
            }
          } catch {
            Write-Host "winget not available or failed, falling back to manual installation"
          }

          # Fallback: Download and install Swift 6.2 for Windows manually
          $swiftUrl = "https://download.swift.org/swift-6.2-release/windows10/swift-6.2-RELEASE/swift-6.2-RELEASE-windows10.exe"
          $swiftInstaller = "$env:TEMP\swift-installer.exe"
          Write-Host "Downloading Swift from $swiftUrl"
          Invoke-WebRequest -Uri $swiftUrl -OutFile $swiftInstaller

          # Install Swift silently
          Write-Host "Installing Swift..."
          Start-Process -FilePath $swiftInstaller -ArgumentList "/S" -Wait

          # Check both possible installation paths after manual installation
          $swiftPaths = @(
            "$env:LOCALAPPDATA\Programs\Swift\bin",
            "C:\Program Files\Swift\bin"
          )

          $swiftFound = $false
          foreach ($swiftPath in $swiftPaths) {
            if (Test-Path $swiftPath) {
              $env:PATH = "$swiftPath;$env:PATH"
              echo "$swiftPath" >> $env:GITHUB_PATH
              Write-Host "Added Swift to PATH: $swiftPath"
              $swiftFound = $true
              break
            }
          }

          if (-not $swiftFound) {
            Write-Host "Swift installation path not found in any expected location"
            Write-Host "Checked paths: $($swiftPaths -join ', ')"
            # List all Swift-related directories for debugging
            Get-ChildItem -Path "$env:LOCALAPPDATA\Programs" -Name "*swift*" -ErrorAction SilentlyContinue | ForEach-Object { Write-Host "Found: $_" }
            Get-ChildItem -Path "C:\Program Files" -Name "*swift*" -ErrorAction SilentlyContinue | ForEach-Object { Write-Host "Found: $_" }
          }

      - name: Install macOS dependencies
        if: runner.os == 'macOS'
        run: |
          brew install assimp

      - name: Install Linux dependencies
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            cmake \
            ninja-build \
            pkg-config \
            xorg-dev \
            libwayland-dev \
            libxrandr-dev \
            libxi-dev \
            libxcursor-dev \
            libxinerama-dev \
            libxkbcommon-dev \
            mesa-common-dev \
            libgl1-mesa-dev \
            libglu1-mesa-dev \
            libasound2-dev \
            libpulse-dev \
            libudev-dev \
            zlib1g-dev \
            libassimp-dev

      - name: Clear SwiftPM cache (macOS & Linux)
        if: runner.os != 'Windows'
        run: |
          rm -rf ~/.swiftpm
          rm -rf glass/.build
          rm -rf glass/.swiftpm
          rm -f glass/Package.resolved
          cd glass && swift package clean

      - name: Clear SwiftPM cache (Windows)
        if: runner.os == 'Windows'
        run: |
          Remove-Item -Recurse -Force "$env:USERPROFILE\.swiftpm" -ErrorAction SilentlyContinue
          Remove-Item -Recurse -Force "glass\.build" -ErrorAction SilentlyContinue
          Remove-Item -Recurse -Force "glass\.swiftpm" -ErrorAction SilentlyContinue
          Remove-Item -Force "glass\Package.resolved" -ErrorAction SilentlyContinue

      # - name: Cache SwiftPM
      #   uses: actions/cache@v4
      #   with:
      #     path: |
      #       ~/.swiftpm
      #       glass/.build
      #     key: ${{ runner.os }}-spm-${{ hashFiles('glass/Package.resolved') }}
      #     restore-keys: |
      #       ${{ runner.os }}-spm-

      - name: Show Swift version (macOS & Linux)
        if: runner.os != 'Windows'
        run: swift --version

      - name: Show Swift version (Windows)
        if: runner.os == 'Windows'
        run: |
          Write-Host "Checking Swift installation on Windows..."
          $swiftPaths = @(
            "$env:LOCALAPPDATA\Programs\Swift\bin",
            "C:\Program Files\Swift\bin"
          )
          foreach ($swiftPath in $swiftPaths) {
            if (Test-Path $swiftPath) {
              Write-Host "Found Swift at: $swiftPath"
              $env:PATH = "$swiftPath;$env:PATH"
              break
            }
          }
          Write-Host "Current PATH: $env:PATH"
          swift --version

      - name: Build (debug) - macOS & Linux
        if: runner.os != 'Windows'
        working-directory: glass
        run: swift build -v --enable-experimental-prebuilts

      - name: Build (debug) - Windows
        if: runner.os == 'Windows'
        working-directory: glass
        run: |
          # Ensure Swift is in PATH for Windows
          $swiftPaths = @(
            "$env:LOCALAPPDATA\Programs\Swift\bin",
            "C:\Program Files\Swift\bin"
          )
          foreach ($swiftPath in $swiftPaths) {
            if (Test-Path $swiftPath) {
              $env:PATH = "$swiftPath;$env:PATH"
              break
            }
          }
          swift build -v --enable-experimental-prebuilts

      - name: Build (release) - macOS & Linux
        if: runner.os != 'Windows'
        working-directory: glass
        run: swift build -c release -v --enable-experimental-prebuilts

      - name: Build (release) - Windows
        if: runner.os == 'Windows'
        working-directory: glass
        run: |
          # Ensure Swift is in PATH for Windows
          $swiftPaths = @(
            "$env:LOCALAPPDATA\Programs\Swift\bin",
            "C:\Program Files\Swift\bin"
          )
          foreach ($swiftPath in $swiftPaths) {
            if (Test-Path $swiftPath) {
              $env:PATH = "$swiftPath;$env:PATH"
              break
            }
          }
          swift build -c release -v --enable-experimental-prebuilts
