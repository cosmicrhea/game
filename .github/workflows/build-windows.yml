name: Build for Windows

on:
  workflow_dispatch:

permissions:
  contents: read

jobs:
  build:
    runs-on: windows-2022
    env:
      GAME_LOCAL_DEPS: "0"
    steps:
      - name: Checkout game
        uses: actions/checkout@v4
        with:
          path: game
          lfs: true

      - name: Set up Swift 6.2
        run: |
          # Install winget if not available
          Write-Host "Checking for winget..."
          try {
            $wingetVersion = winget --version
            Write-Host "winget found: $wingetVersion"
          } catch {
            Write-Host "winget not found, installing it..."
            # Use the winget-install script
            Invoke-Expression "& { $(Invoke-RestMethod 'https://raw.githubusercontent.com/asheroto/winget-install/master/winget-install.ps1') }"
            Write-Host "winget installed, checking version..."
            $wingetVersion = winget --version
            Write-Host "winget version after install: $wingetVersion"
          }

          # Try to install Swift via winget first
          Write-Host "Attempting to install Swift via winget..."
          Write-Host "Running: winget install --id Swift.Toolchain -e --accept-package-agreements --accept-source-agreements"
          $wingetResult = winget install --id Swift.Toolchain -e --accept-package-agreements --accept-source-agreements 2>&1
          Write-Host "Winget install result: $wingetResult"
          Write-Host "Winget install exit code: $LASTEXITCODE"

          # Check both possible installation paths
          $swiftPaths = @(
            "$env:LOCALAPPDATA\Programs\Swift\bin",
            "C:\Program Files\Swift\bin"
          )

          $swiftFound = $false
          foreach ($swiftPath in $swiftPaths) {
            if (Test-Path $swiftPath) {
              $env:PATH = "$swiftPath;$env:PATH"
              echo "$swiftPath" >> $env:GITHUB_PATH
              Write-Host "Swift installed via winget successfully at: $swiftPath"
              $swiftFound = $true
              break
            }
          }

          if ($swiftFound) {
            Write-Host "Swift found via winget, skipping manual installation"
          } else {
            Write-Host "Swift not found in expected paths after winget installation"
            
            # Debug: Check what winget packages are installed
            Write-Host "Checking installed winget packages..."
            winget list | Select-String -Pattern "swift" -CaseSensitive:$false

            # Debug: Search for Swift packages
            Write-Host "Searching for Swift packages in winget..."
            winget search swift

            Write-Host "Trying manual installation..."
          }

          # Fallback: Download and install Swift 6.2 for Windows manually
          $swiftUrl = "https://download.swift.org/swift-6.2-release/windows10/swift-6.2-RELEASE/swift-6.2-RELEASE-windows10.exe"
          $swiftInstaller = "$env:TEMP\swift-installer.exe"
          Write-Host "Downloading Swift from $swiftUrl"
          Invoke-WebRequest -Uri $swiftUrl -OutFile $swiftInstaller

          # Install Swift silently
          Write-Host "Installing Swift..."
          $installProcess = Start-Process -FilePath $swiftInstaller -ArgumentList "/S" -Wait -PassThru
          Write-Host "Swift installer exit code: $($installProcess.ExitCode)"

          # Wait a moment for installation to complete
          Start-Sleep -Seconds 5

          # Check both possible installation paths after manual installation
          $swiftPaths = @(
            "$env:LOCALAPPDATA\Programs\Swift\bin",
            "C:\Program Files\Swift\bin"
          )

          $swiftFound = $false
          foreach ($swiftPath in $swiftPaths) {
            if (Test-Path $swiftPath) {
              $env:PATH = "$swiftPath;$env:PATH"
              echo "$swiftPath" >> $env:GITHUB_PATH
              Write-Host "Added Swift to PATH: $swiftPath"
              $swiftFound = $true
              break
            }
          }

          if (-not $swiftFound) {
            Write-Host "Swift installation path not found in any expected location"
            Write-Host "Checked paths: $($swiftPaths -join ', ')"
            # List all Swift-related directories for debugging
            Write-Host "Searching for Swift installations..."
            Get-ChildItem -Path "$env:LOCALAPPDATA\Programs" -Name "*swift*" -ErrorAction SilentlyContinue | ForEach-Object { Write-Host "Found in LocalAppData: $_" }
            Get-ChildItem -Path "C:\Program Files" -Name "*swift*" -ErrorAction SilentlyContinue | ForEach-Object { Write-Host "Found in Program Files: $_" }
            Get-ChildItem -Path "C:\Program Files (x86)" -Name "*swift*" -ErrorAction SilentlyContinue | ForEach-Object { Write-Host "Found in Program Files (x86): $_" }
            
            # Check if winget actually installed anything
            Write-Host "Checking winget installed packages..."
            winget list --name "Swift" 2>$null | ForEach-Object { Write-Host "Winget Swift packages: $_" }
            
            # Try to find Swift anywhere on the system
            Write-Host "Searching entire C: drive for swift.exe..."
            $swiftExe = Get-ChildItem -Path "C:\" -Name "swift.exe" -Recurse -ErrorAction SilentlyContinue | Select-Object -First 5
            if ($swiftExe) {
              Write-Host "Found swift.exe at: $($swiftExe -join ', ')"
            } else {
              Write-Host "No swift.exe found anywhere on C: drive"
            }
          }

      - name: Clear SwiftPM cache
        run: |
          Remove-Item -Recurse -Force "$env:USERPROFILE\.swiftpm" -ErrorAction SilentlyContinue
          Remove-Item -Recurse -Force "game\.build" -ErrorAction SilentlyContinue
          Remove-Item -Recurse -Force "game\.swiftpm" -ErrorAction SilentlyContinue
          Remove-Item -Force "game\Package.resolved" -ErrorAction SilentlyContinue

      - name: Show Swift version
        run: |
          Write-Host "Checking Swift installation on Windows..."
          $swiftPaths = @(
            "$env:LOCALAPPDATA\Programs\Swift\bin",
            "C:\Program Files\Swift\bin"
          )
          $swiftFound = $false
          foreach ($swiftPath in $swiftPaths) {
            if (Test-Path $swiftPath) {
              Write-Host "Found Swift at: $swiftPath"
              $env:PATH = "$swiftPath;$env:PATH"
              echo "$swiftPath" >> $env:GITHUB_PATH
              $swiftFound = $true
              break
            }
          }
          if (-not $swiftFound) {
            Write-Host "ERROR: Swift not found in any expected path"
            Write-Host "Checked paths: $($swiftPaths -join ', ')"
            exit 1
          }
          Write-Host "Current PATH: $env:PATH"
          swift --version

      - name: Build (debug)
        working-directory: game
        run: |
          # Ensure Swift is in PATH for Windows
          $swiftPaths = @(
            "$env:LOCALAPPDATA\Programs\Swift\bin",
            "C:\Program Files\Swift\bin"
          )
          foreach ($swiftPath in $swiftPaths) {
            if (Test-Path $swiftPath) {
              $env:PATH = "$swiftPath;$env:PATH"
              echo "$swiftPath" >> $env:GITHUB_PATH
              break
            }
          }
          swift build --quiet --enable-experimental-prebuilts

      - name: Build (release)
        working-directory: game
        run: |
          # Ensure Swift is in PATH for Windows
          $swiftPaths = @(
            "$env:LOCALAPPDATA\Programs\Swift\bin",
            "C:\Program Files\Swift\bin"
          )
          foreach ($swiftPath in $swiftPaths) {
            if (Test-Path $swiftPath) {
              $env:PATH = "$swiftPath;$env:PATH"
              echo "$swiftPath" >> $env:GITHUB_PATH
              break
            }
          }
          swift build -c release --quiet --enable-experimental-prebuilts
