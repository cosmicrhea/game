name: Build for Linux

on:
  workflow_dispatch:

permissions:
  contents: read

jobs:
  build:
    runs-on: ubuntu-22.04
    env:
      GAME_LOCAL_DEPS: "0"
    steps:
      - name: Checkout glass
        uses: actions/checkout@v4
        with:
          path: glass
          lfs: true

      - name: Set up Swift 6.2
        uses: mman/setup-swift@main
        with:
          swift-version: "6.2"

      - name: Install Linux dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            cmake \
            ninja-build \
            pkg-config \
            xorg-dev \
            libwayland-dev \
            libxrandr-dev \
            libxi-dev \
            libxcursor-dev \
            libxinerama-dev \
            libxkbcommon-dev \
            mesa-common-dev \
            libgl1-mesa-dev \
            libglu1-mesa-dev \
            libasound2-dev \
            libpulse-dev \
            libudev-dev \
            zlib1g-dev \
            libassimp-dev

      - name: Clear SwiftPM cache
        run: |
          rm -rf ~/.swiftpm
          rm -rf glass/.build
          rm -rf glass/.swiftpm
          rm -f glass/Package.resolved
          cd glass && swift package clean

      - name: Free up disk space
        run: |
          df -h
          echo "slaying unused toolchains…"

          # android sdk (HUUUGE)
          sudo rm -rf /usr/local/lib/android || true

          # dotnet
          sudo rm -rf /usr/share/dotnet || true

          # docker images + cache
          docker image prune -af || true
          docker system prune -af || true

          # haskell/ghc
          sudo rm -rf /opt/ghc || true

          # llvm (massive)
          sudo rm -rf /usr/local/clang* /usr/local/llvm* || true

          # large language/model packs you prob don't need
          sudo rm -rf /usr/share/swift || true

          echo "ok queen the disk is serving CLEAN ✨"
          df -h

      - name: Show Swift version
        run: swift --version

      - name: Check disk space before build
        run: |
          df -h
          echo "Available space: $(df -h / | tail -1 | awk '{print $4}')"

      - name: Build (debug)
        working-directory: glass
        run: swift build --quiet --enable-experimental-prebuilts

      - name: Clean debug build artifacts
        run: |
          echo "Cleaning debug build to free space for release build..."
          rm -rf glass/.build
          df -h

      - name: Build (release)
        working-directory: glass
        run: swift build -c release --quiet --enable-experimental-prebuilts
